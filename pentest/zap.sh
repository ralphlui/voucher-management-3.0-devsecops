#!/bin/bash

DAST_URL=$1
MODE=$2

# Check if the parameter is provided
if [ -z "$DAST_URL" ]; then
  echo "Error: Missing parameter. Please provide the DAST URL."
  exit 1
fi

if [ -z "$MODE" ]; then
  echo "Error: Missing parameter. Please provide the MODE(full/base)."
  exit 1
fi

echo "DAST URL is: $DAST_URL"
echo "MODE is: $MODE"

ACCESS_TOKEN=$(curl -s -X POST "${DAST_HOST}/api/users/login" \
                   -H "Content-Type: application/json" \
                   -d '{"email": "khinyadanarnaing1@gmail.com", "password": "12345678"}' \
                   -i | grep -oP 'access_token=\K[^;]+')

if [ "$MODE" == "full" ]; then
    docker run --rm -e ZAP_AUTH_HEADER_VALUE="Bearer ${ACCESS_TOKEN}" \
    -v /tmp:/zap/wrk/:rw -t zaproxy/zap-stable \
    zap-full-scan.py -t ${DAST_URL} -z "-config scan.threadPerHost=10" -z "-config spider.thread=10" -z "-config scanner.maxScanDurationInMins=30" -r zap_report.html 2> /dev/null; (($? == 2)) && echo 'Done' >&2
else
    docker run --rm -e ZAP_AUTH_HEADER_VALUE="Bearer ${ACCESS_TOKEN}" \
    -v /tmp:/zap/wrk/:rw -t zaproxy/zap-stable \
    zap-baseline.py -t ${DAST_URL} -r zap_report.html 2> /dev/null; (($? == 2)) && echo 'Done' >&2
