#!/bin/bash

SCAN_URL=$1
SEED_URL=$2
OUTDIR=$3

# Check if the parameter is provided
if [ -z "$SCAN_URL" ]; then
  echo "Error: Missing parameter. Please provide the host url."
  exit 1
fi


if [ -z "$SEED_URL" ]; then
  echo "Error: Missing parameter. Please provide the SEED file url."
  exit 1
fi

if [ -z "$OUTDIR" ]; then
  echo "Error: Missing parameter. Please provide the output file directory."
  exit 1
fi

echo "SCAN HOST is: $SCAN_URL"
echo "SEED URL is: $SEED_URL"
echo "OUTPUT DIRECTORY is: $OUTDIR"

if [ ! -d "${OUTDIR}" ]; then
  mkdir "${OUTDIR}"
  echo "Directory ${OUTDIR} created."
else
  echo "Directory ${OUTDIR} already exists."
fi

ACCESS_TOKEN=$(curl -s -X POST "${SCAN_URL}/api/users/login" \
                   -H "Content-Type: application/json" \
                   -d '{"email": "khinyadanarnaing1@gmail.com", "password": "12345678"}' \
                   -i | grep -oP 'access_token=\K[^;]+')

python3 /var/lib/jenkins/XSStrike/xsstrike.py --seeds ${SEED_URL} --headers "Authorization: Bearer ${ACCESS_TOKEN}" | tee ${OUTDIR}/xsstrike_1.txt

while IFS= read -r url; do
  echo "Scanning URL: $url"
  python3 /var/lib/jenkins/XSStrike/xsstrike.py -u "$url" --headers "Authorization: Bearer ${ACCESS_TOKEN}" --fuzzer | tee -a ${OUTDIR}/xsstrike_2.txt
done < "$SEED_URL"
